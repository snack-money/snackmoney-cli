name: Release and Publish

on:
  push:
    tags:
      - 'v*'

jobs:
  # Job 1: Publish to npm first (everything depends on this)
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Update npm
        run: npm install -g npm@latest

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Publish to npm
        run: npm publish --access public --provenance

  # Job 2: Update Homebrew formula (runs after npm publish succeeds)
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: publish-npm  # Wait for npm to publish first
    steps:
      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Wait for npm package to be available
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          echo "Waiting for snackmoney@${VERSION} to be available on npm..."
          for i in {1..30}; do
            if npm view snackmoney@${VERSION} version &>/dev/null; then
              echo "Package is available!"
              exit 0
            fi
            echo "Attempt $i: Package not yet available, waiting 10 seconds..."
            sleep 10
          done
          echo "Package not available after 5 minutes"
          exit 1

      - name: Download tarball and get SHA256
        id: sha
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          curl -L "https://registry.npmjs.org/snackmoney/-/snackmoney-${VERSION}.tgz" -o snackmoney.tgz
          SHA256=$(shasum -a 256 snackmoney.tgz | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: snack-money/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          cd homebrew-tap
          VERSION=${{ steps.version.outputs.VERSION }}
          SHA256=${{ steps.sha.outputs.SHA256 }}

          # Create Formula directory if it doesn't exist
          mkdir -p Formula

          # Create or update the formula
          if [ ! -f Formula/snackmoney.rb ]; then
            # Create new formula
            cat > Formula/snackmoney.rb <<EOF
          class Snackmoney < Formula
            desc "CLI tool for sending USDC payments via Snack Money API"
            homepage "https://github.com/snack-money/snackmoney-cli"
            url "https://registry.npmjs.org/snackmoney/-/snackmoney-${VERSION}.tgz"
            sha256 "${SHA256}"
            license "MIT"

            depends_on "node"

            def install
              system "npm", "install", *Language::Node.std_npm_install_args(libexec)
              bin.install_symlink Dir["#{libexec}/bin/*"]
            end

            test do
              system "#{bin}/snackmoney", "--version"
            end
          end
          EOF
          else
            # Update existing formula
            sed -i "s|url \"https://registry.npmjs.org/snackmoney/-/snackmoney-.*\.tgz\"|url \"https://registry.npmjs.org/snackmoney/-/snackmoney-${VERSION}.tgz\"|g" Formula/snackmoney.rb
            sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|g" Formula/snackmoney.rb
          fi

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/snackmoney.rb
          git commit -m "Update snackmoney to v${{ steps.version.outputs.VERSION }}"
          git push
